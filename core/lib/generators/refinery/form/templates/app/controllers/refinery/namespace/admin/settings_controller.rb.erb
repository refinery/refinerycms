module Refinery
  module <%= class_name.pluralize %>
    module Admin
      class SettingsController < Refinery::AdminController

        before_action :check_setting, :only => [:edit, :update]
        after_action :save_subject_for_confirmation, :save_message_for_confirmation, :only => :update

        def edit
          @setting = Refinery::Setting.find(params[:id])
        end

        def update
          @setting = Refinery::Setting.find(params[:id])

          if @setting.update_attributes(setting_params)
            flash[:notice] = t('refinery.crudify.updated', :what => @setting.name.gsub("<%= singular_name %>_", "").titleize)

            if request.xhr? or from_dialog?
              render :text => "<script type='text/javascript'>parent.window.location = '#{refinery.<%= namespacing.underscore %>_admin_<%= plural_name %>_path}';</script>"
            else
              redirect_back_or_default(refinery.<%= namespacing.underscore %>_admin_<%= plural_name %>_path)
            end
          end
        end

      protected

        def setting_params
          params.require(:setting).permit(:value)
        end

        def check_setting
          scoped_setting_id = params[:id].gsub("<%= singular_name %>_", "")

          Refinery::Setting.send(scoped_setting_id) if Refinery::<%= namespacing %>::Setting.respond_to?(params[:id])
        end

        def save_subject_for_confirmation
          Refinery::<%= namespacing %>::Setting.confirmation_subject = params[:confirmation_subject] if params.keys.include?('confirmation_subject')
        end

        def save_message_for_confirmation
          Refinery::<%= namespacing %>::Setting.confirmation_message = params[:confirmation_message] if params.keys.include?('confirmation_message')
        end

        private

        def setting_params
          params.require(:setting).permit(:value,
                                          subject: Refinery::I18n.frontend_locales,
                                          message: Refinery::I18n.frontend_locales)
        end
      end
    end
  end
end
