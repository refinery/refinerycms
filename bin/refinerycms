#!/usr/bin/env ruby
# Load bundler
begin
  require 'rubygems'
  require 'bundler'
rescue LoadError
  puts "\n=== ACTION REQUIRED ===\n\n"
  puts "Could not load the bundler gem. This is a required dependency of Refinery CMS."
  puts "Please install it with `gem install bundler`.\n\n"
  exit
end

# Load other required libraries
require 'pathname'
require 'fileutils'
require 'optparse'

require 'child_labor' if RUBY_PLATFORM !~ /mswin3?2?/

# Load refinerycms
require Pathname.new(File.expand_path(File.dirname(__FILE__) << "/..")).join('vendor', 'refinerycms', 'core', 'lib', 'refinery.rb')

module Refinery
  class AppGenerator

    def initialize(input)
      # Default options
      @input = input
      @options = {
        :database => 'sqlite3',
        :force => false
      }

      @optparse = OptionParser.new do |opts|
        opts.banner = "Purpose: Installs Refinery CMS to the specified directory"
        opts.banner << "\nUsage:   #{opts.program_name} /path/to/project [options]"

        opts.separator ""
        opts.separator "Specific Options:"

        # Rails supports more options, but Refinery is only tested on these three
        databases = %w(mysql postgresql sqlite3)
        opts.on("-d DATABASE", "--database DATABASE", databases, "Select the database (default sqlite3)", "  #{databases.join('/')}") do |db|
          @options[:database] = db
        end

        opts.on("-f", "--force", "Force overwriting of directory") do
          @options[:force] = true
        end

        opts.separator ""
        opts.separator "Common options:"

        opts.on_tail("-h", "--help", "Display this screen") do
          puts opts
          exit
        end

        opts.on_tail("-v", "--version", "Display the version") do
          puts Refinery.version
          exit
        end
      end
    end

    def run!
      # Grab input and ensure that the path doesn't exist already and other checks.
      validate!

      # Generate a Refinery CMS application
      generate!

      # Add in the Refinery specifics to the application
      refine!

      # Output helpful messages to user
      output!
    end


    def validate!
      # Check for valid input
      begin
        @optparse.parse!(@input)
      rescue OptionParser::ParseError => pe
        puts pe
        puts "\n"
        puts @optparse
        exit
      end

      # Ensure only one path is specified
      unless @input.size == 1
        puts "Please specify a single path to install Refinery CMS"
        puts "\n"
        puts @optparse
        exit
      end

      # Get the name and path of the new application
      @app_path = Pathname.new(File.expand_path(@input.first))
      @app_name = @app_path.to_s.split(File::SEPARATOR).last

      if @app_path.directory? and @options[:force] == false
        puts "The directory '#{@app_path}' that you specified already exists."
        puts "Use --force to overwrite an existing directory."
        exit
      end
    end

    def generate!
      # Generate a rails application
      rails_command = "rails new #{@app_path}"
      rails_command << " --database #{@options[:database]}"
      rails_command << " --force" if @options[:force]
      rails_command << " --skip-test-unit --skip-prototype"
      run_command(rails_command, {:cd => false})
    end

    def refine!
      # Overwrite rails defaults with refinery defaults
      %w(app db).each do |folder|
        FileUtils::cp_r Refinery.root.join(folder), @app_path, :verbose => false
      end
      %w(.gitignore config/routes.rb config/settings.rb config/initializers/acts_as_indexed_config.rb
          config/initializers/field_with_error_fix.rb config/initializers/fix_rack.rb).each do |file|
        FileUtils::cp_r Refinery.root.join(file), @app_path.join(file), :verbose => false
      end

      # Remove public/index.html
      if (rails_index_placeholder = @app_path.join('public', 'index.html')).exist?
        FileUtils::rm rails_index_placeholder.to_s
      end

      if (app_layout = @app_path.join('app', 'views', 'layouts', 'application.html.erb')).exist?
        FileUtils::rm app_layout.to_s
      end

      # Add refinery gems to the Gemfile
      gemfile_contents = File.read(Refinery.root.join('Gemfile'))
      refinery_gems = gemfile_contents.match(/# REFINERY CMS =+.*# END REFINERY CMS =+/m)[0]
      File.open(@app_path.join('Gemfile'), "a") do |f|
        f.write "\n" + refinery_gems
      end

      # Hack to make work on development computers
      # TODO: Change this when/if separate gems are released for each engine
      find_and_replace('Gemfile', "path 'vendor/refinerycms' do",
                        "path '#{Pathname.new(File.expand_path(File.dirname(__FILE__) << "/..")).join('vendor').to_s}/refinerycms' do")

      # Replace app constant with Refinery
      # TODO: Find a way around this
      camelized_app_name = @app_name.gsub(/\/(.?)/) { "::#{$1.upcase}" }.gsub(/(?:^|_)(.)/) { $1.upcase }
      %w(Rakefile config.ru config/application.rb config/environment.rb
          config/environments/development.rb config/environments/production.rb config/environments/test.rb
          config/initializers/secret_token.rb config/initializers/session_store.rb).each do |hackable|
        find_and_replace(hackable, camelized_app_name, "Refinery")
      end

      # Remove development specific stuff from the .gitinore file
      find_and_replace('.gitignore',
                       /# REFINERY CMS DEVELOPMENT =+.*# END REFINERY CMS DEVELOPMENT =+/m,
                       '')
    end

    def output!
      puts "\n---------"
      puts "Refinery successfully installed in '#{@app_path}'!\n\n"

      # Automate
      puts "Installing gem requirements using bundler..\n"
      run_command("bundle install")

      puts "\n\nSetting up your development database..\n"
      run_command("rake -f '#{@app_path.join('Rakefile')}' db:setup")
      # End automation

      # Output helpful messages
      puts "\n=== ACTION REQUIRED ==="
      puts "Now you can launch your webserver using:"
      puts "\ncd #{@app_path}"
      puts "rails server"
      puts "\nThis will launch the built-in webserver at port 3000."
      puts "You can now see your site running in your browser at http://localhost:3000"
      puts "\nThanks for installing Refinery, enjoy creating your new application!"
      puts "---------\n\n"
    end

    private :validate!, :generate!, :refine!, :output!

    def run_command(command, options = {})
      options = {:cd => true, :puts => true}.merge(options)
      to_run = ((forkable = RUBY_PLATFORM !~ /mswin3?2?/) ? "" : "cmd /c ")
      to_run << "cd #{@app_path} && " if options[:cd]
      to_run << command

      if forkable
        if options[:puts]
          puts "Running: #{to_run}"
          ::ChildLabor.subprocess(to_run) do |t|
            while (line = t.gets)
              puts line
            end
          end
        else
          ::ChildLabor.subprocess(to_run)
        end
      else
        if options[:puts]
          puts "Running: #{to_run}"
          IO.popen(to_run) do |t|
            while (line = t.gets)
              puts line
            end
          end
        else
          `#{to_run}`
        end
      end
    end

    def find_and_replace(file, find, replace)
      (contents = @app_path.join(file).read).gsub!(find, replace)
      (@app_path + file).open("w") do |f|
        f.puts contents
      end
    end

    protected :run_command, :find_and_replace
  end
end

unless !defined?(::ChildLabor::Task) or ::ChildLabor::Task.instance_methods.include?(:gets)
  ::ChildLabor::Task.module_eval do
    def gets
      @stdout.gets
    end
  end
end
Refinery::AppGenerator.new(ARGV).run!